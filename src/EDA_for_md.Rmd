---
title: "Exploratory Data Analysis for US social determinants of health by county dataset"
author: "Group 25"
date: "11/27/2021"
bibliography: references.bib
output:
  md_document:
    variant: markdown_github
---


## Setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load libraries, message=FALSE, warning=FALSE}
library(tidyverse)
library(plotly)
library(broom)
library(knitr)
```

Our GitHub Repo:
[**https://github.com/UBC-MDS/DSCI_522_US_social_determinants_of_health_by_county**](https://github.com/UBC-MDS/DSCI_522_US_social_determinants_of_health_by_county){.uri}

## Load Data

```{r load datasets for this assignment, message=FALSE}
covid_data <- read.csv('data/processed/cleaned_data.csv')
  
n_nas <- nrow(covid_data) - (drop_na(covid_data) %>% tally())

```


The original data set used in this project is of US social determinants
of health by county created by Dr. John Davis at Indiana University, the
United States [@davis_2020]. Each row in the original data set represents a day with its corresponding
COVID-19 cases (accumulated), number of deaths due to COVID-19
(accumulated), and other demographic statistics.

The original data set contained over 200
features with a high degree of granularity to support different
exploratory questions. We identified a subset of these features whose
relationship to COVID-19 prevalence we believed to be of interest to the
general population based on intuition and validated by a media scan. We
also added a few "wildcard" features ("chlamydia" and "teen birth rate")
which might be related to broader social determinants of public health.
In the future, we might choose to add additional features as they are
requested by the community or become of interest to the team.

In addition, our original data reported observations as a time series per county. However, due to limits in measurement and reporting, their was a varied rate of change for different features (e.g. COVID-19 cases were reported daily, whereas many other features were reported no more than once per month). As such, we believe it is most effective to summarize the data into static summary measures per county. In the processed data, we normalized the teen birth rate by per thousand females, and all other rates are by per 100k people. 

Each row in the processed data set contains normalized COVID-19 related features and other normalized demographic statistics for each county. There are `r nrow(covid_data)` observations in the data set, and
`r ncol(covid_data) - 1` features. There are `r n_nas` observations with
missing values in the data set. Below we show the descriptive statistics
of the dataset. 


## Descriptive Statistics

Here we demonstrated

-   the internal structure of the dataset;
-   summary data related to the individual features;
-   the top of the dataset;
-   the bottom of the dataset; and
-   the number of unique values in each feature.

```{r check the descriptive stats of the data frame}
str(covid_data)
kable(summary(covid_data))
kable(head(covid_data))
kable(tail(covid_data))

apply(covid_data, 2, function(x) length(unique(x)))
```



## Exploratory Data Analysis (EDA)

To look at whether each of the features might be useful to determine the change of COVID-19 cases, we first created two summary tables to check COVID-19 prevalence for each state and for each county. 



### Table of COVID-19 prevalence for every county

```{r table of covid prevalence for each county, message=FALSE}
covid_prevalence_table_county <- covid_data %>%
  select(county, 
         state, 
         max_cases, 
         cases_per_100k, 
         avg_growth_rate, 
         max_growth_rate) %>%
  arrange(desc(max_cases)) 


kable(head(data.frame(covid_prevalence_table_county)), 
      caption = "Table 1. Top 5 counties with highest COVID-19 growth rate.")
kable(tail(data.frame(covid_prevalence_table_county)), 
      caption = "Table 2. Top 5 counties with lowest COVID-19 growth rate.")

```

### Table of COVID-19 prevalence for every state

```{r table of covid prevalence for each state, message=FALSE}
covid_prevalence_table_state <- covid_data %>%
  group_by(state) %>%
  summarize(max_cases = sum(max_cases),
  cases_per_100k = sum(cases_per_100k, na.rm=TRUE),
  avg_growth_rate = mean(avg_growth_rate, na.rm=TRUE), 
  max_growth_rate = mean(max_growth_rate)) %>%
  arrange(desc(max_cases)) 

kable(head(data.frame(covid_prevalence_table_state)), 
      caption = "Table 3. Top 5 states with highest COVID-19 growth rate.")
kable(tail(data.frame(covid_prevalence_table_state)), 
      caption = "Table 4. Top 5 states with lowest COVID-19 growth rate.")
```


### Visualization 1 - distributions of numeric features

Then we created density plots for all numeric variables to check the distributions.

```{r density plots for numeric variables, warning=FALSE, fig.cap="Figure 1. Density plots of numeric feature", out.width="100%"}


par(mfrow=c(3, 4))

covid_data_group_by_sate <- covid_data %>%
  group_by(state) %>%
  summarize(max_cases = sum(max_cases),
            cases_per_100k = sum(cases_per_100k, na.rm=TRUE),
            avg_growth_rate = mean(avg_growth_rate, na.rm=TRUE), 
            max_growth_rate = mean(max_growth_rate),
            total_population = sum(total_population), 
            num_deaths = sum(num_deaths),
            percent_smokers = mean(percent_smokers),
            percent_vaccinated = mean(percent_vaccinated),
            income_ratio = mean(income_ratio),
            population_density_per_sqmi = mean(population_density_per_sqmi),
            percent_fair_or_poor_health = mean(percent_fair_or_poor_health),
            percent_unemployed_CHR = mean(percent_unemployed_CHR),
            violent_crime_rate = mean(violent_crime_rate),
            chlamydia_rate = mean(chlamydia_rate),
            teen_birth_rate = mean(teen_birth_rate),
            deaths_per_100k = sum(deaths_per_100k)) 

covid_data_group_by_sate %>%
  select_if(is.numeric) %>%
  pivot_longer(everything()) %>%
  ggplot(aes(x=value)) + 
  geom_density(fill='grey') +
  facet_wrap(~name, scales='free') + 
  theme(strip.text = element_text(size=7),
        axis.text.x = element_text(size=5), 
        axis.text.y = element_text(size=5), 
        plot.title = element_text(hjust = 0.5)) +
  labs(x ="", 
       y = "Density") 


```

### Visualization 2 - relationships between total COVID-19 cases per 100k of each state and other features

In addition, we created plots to demonstrate relationshipts between COVID-19 cases per 100k of each state and other features in the dataset.

```{r cases per 100k vs other features, warning=FALSE, fig.cap="Figure 2. Plots of total COVID-19 cases per 100k v.s. other features", out.width="100%"}
par(mfrow=c(3, 4))

covid_data_group_by_sate_long <- covid_data_group_by_sate %>%
    select_if(is.numeric) %>%
    pivot_longer(-c(cases_per_100k, avg_growth_rate, max_growth_rate)) 

case_per_100k_plot <- covid_data_group_by_sate_long %>%
  ggplot(aes(x=value, y=cases_per_100k)) + 
  geom_point(alpha = 0.4) +
  facet_wrap(~name, scales='free') +
  theme(strip.text = element_text(size=7),
        axis.text.x = element_text(size=7), 
        axis.text.y = element_text(size=7)) +
  labs(x ="", 
       y = "COVID-19 cases per 100k") +
  scale_x_continuous(labels = scales::label_number_si()) +
  scale_y_continuous(labels = scales::label_number_si())



case_per_100k_plot
```

### Visualization 3 - relationships between average COVID-19 cases growth rate for each state and other features

We also created plots to demonstrate relationshipts between average COVID-19 cases growth rate of each state and other features in the dataset.


```{r growth rate vs other features, warning=FALSE, fig.cap="Figure 3. Plots of average COVID-19 growth rate v.s. other features", out.width="100%"}
par(mfrow=c(3, 4))

covid_growth_rate_plot <- covid_data_group_by_sate_long %>%
  ggplot(aes(x=value, y=avg_growth_rate)) + 
  geom_point(alpha = 0.4) +
  facet_wrap(~name, scales='free') +
  theme(strip.text = element_text(size=7),
        axis.text.x = element_text(size=7), 
        axis.text.y = element_text(size=7)) +
  labs(x ="", 
       y = "COVID-19 average growth rate") +
  scale_x_continuous(labels = scales::label_number_si()) +
  scale_y_continuous(labels = scales::label_number_si())



covid_growth_rate_plot
```

## References